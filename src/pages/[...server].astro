---
/**
 * src/pages/[...server].astro
 *
 * This is a dynamic server-side route component that acts as a fallback for
 * any pages not statically generated by [...build].astro. It is configured
 * with prerender = false to handle requests at runtime.
 *
 * Features:
 * - Server-side rendering (SSR) handling for dynamic content
 * - Fallback for routes not found in static build
 * - Data-driven page generation from YAML configuration
 * - Section-based content architecture
 * - Themeable styling through CSS classes
 * - 404 Handling for undefined routes
 *
 * Route Parameters:
 * - [...server]: Spread parameter capturing the full URL path
 *   - Catches paths not matched by static routes
 *
 * Data Flow:
 * 1. Astro.params extracts the page parameter from the URL
 * 2. getSpecs('pages') loads all page configurations from YAML data files
 * 3. Page-specific data is retrieved using the page slug
 * 4. Checks if page data exists; if not, returns 404
 * 5. getLayout() retrieves layout configuration for consistent structure
 * 6. Sections are dynamically rendered through SectionComponent
 *
 * Component Integration:
 * - PageLayout: Provides consistent page structure with header/footer
 * - SectionComponent: Renders individual content sections dynamically
 * - getLayout: Retrieves layout configuration for the page
 * - getSpecs: Loads page data from YAML configuration
 *
 * Props and Configuration:
 * - page: URL parameter representing the page slug
 * - allPages: Complete collection of page configurations from YAML
 * - pageData: Specific data for the requested page
 * - layoutProps: Layout configuration for consistent page structure
 *
 * Prerendering:
 * - prerender = false: Disables static site generation, ensuring SSR
 * - Content is generated at runtime
 *
 * Usage Context:
 * - Fallback route handler for dynamic or unknown paths
 * - Handles authentication-protected routes or dynamic data pages
 */

import type { Page as PageType, Section as SectionType } from '~/types';
import Layout from '~/layouts/PageLayout.astro';
import { getSpecs } from '~/utils/loader';
import { getLayout } from '~/utils/router';
import SectionComponent from '~/components/page/Section.astro';

// Extract the page parameter from the URL.
// Note: The param name is determined by the filename [...server].astro
const { server: page } = Astro.params;

// Disable static site generation to enable SSR
export const prerender = false;

// Load all page configurations from YAML data files
const allPages = getSpecs('pages');

// Extract requested page specific data and cast to proper type
// If page is undefined (root), default to 'index' or handle appropriately if needed.
// Usually root is handled by index.astro, but if this catches it, we might need care.
// For catch-all, we check the path.
const pageSlug = page || 'index';

const pageData: PageType | undefined = allPages[pageSlug] as PageType | undefined;

// 404 Handling
if (!pageData) {
  return Astro.redirect('/404');
}

// Retrieve layout configuration for consistent page structure
const layoutProps = getLayout(pageSlug);
---

{
  /*
    PageLayout component provides consistent site structure.
    - Wraps content with header, footer, and base layout
    - Spreads layoutProps for page-specific configuration
    - Contains dynamically rendered sections
  */
}
<Layout {...layoutProps}>
  {
    /*
      Conditional rendering of sections when pageData exists.
      - Checks for pageData and sections array
      - Maps through sections to render SectionComponent for each
      - Casts sections to SectionType array for type safety
    */
    pageData &&
      pageData.sections &&
      (pageData.sections as SectionType[]).map((section) => <SectionComponent section={section} />)
  }
</Layout>
