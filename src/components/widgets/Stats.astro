---
/**
 * Stats.astro
 *
 * This component renders a statistics widget that displays key metrics and data points
 * in a visually appealing grid layout. It's designed to showcase important numerical
 * information with optional icons, descriptions, and source links for credibility.
 *
 * Features:
 * - Titled widget structure with optional title, subtitle, and tagline
 * - Grid layout for multiple statistical items
 * - Support for numerical amounts with customizable formatting
 * - Optional icons for visual representation of each stat
 * - Expandable descriptions for detailed explanations
 * - Source links for statistical credibility
 * - Themeable styling through CSS classes
 * - Accessible structure with proper labeling
 *
 * Props (extends TitledWidget interface):
 * - id (optional): HTML id attribute for the widget container
 * - title (optional): Widget title (can be passed via slot or prop)
 * - subtitle (optional): Widget subtitle (can be passed via slot or prop)
 * - tagline (optional): Widget tagline (can be passed via slot or prop)
 * - stats: Array of Stat objects representing statistical items
 * - sourceLabel: Label text for source links (defaults to '** Source')
 * - classes (optional): CSS class configuration object
 * - bg (optional): Background image URL string
 *
 * Stat Structure:
 * - amount: Numerical value or formatted string for the statistic
 * - title: Short descriptive title for the statistic
 * - icon: Optional icon identifier for visual representation
 * - description: Detailed explanation of the statistic (expandable)
 * - source: URL to the source of the statistical data
 *
 * Styling Inputs:
 * - getClasses('Component+Stats'): Retrieves CSS classes for statistics elements
 *   from the theme's style configuration:
 *   - wrapper: Classes for the TitledWidgetWrapper container
 *   - headline: Classes for the TitledWidgetWrapper container
 *   - container: Classes for the main stats grid container
 *   - stat: Classes for individual stat item containers
 *   - icon_container: Classes for icon wrapper containers
 *   - icon: Classes for Icon components
 *   - amount: Classes for numerical amount display
 *   - source_container: Classes for source link containers
 *
 * Component Integration:
 * - TitledWidgetWrapper: Provides consistent titled widget structure
 * - Expander: Component for expandable descriptions
 * - Icon: Astro icon component for visual indicators
 * - getClasses: Manages theme-based styling
 *
 * Data Flow:
 * 1. Receives statistics configuration through Astro.props
 * 2. Maps through stats array to render individual statistical items
 * 3. Conditionally renders icons, amounts, titles, and source links
 * 4. Uses Expander component for detailed descriptions when both title and description exist
 * 5. Wraps content in TitledWidgetWrapper for consistent structure
 * 6. Applies theme-based styling through getClasses utility
 *
 * Layout Structure:
 * - TitledWidgetWrapper provides outer container with title/subtitle/tagline
 * - Main container holds grid of statistical items
 * - Each stat item contains icon, amount, title/description, and source
 *
 * Responsive Behavior:
 * - Grid layout adapts to screen size with responsive columns
 * - Number of columns based on available stats items
 * - Items stack vertically on mobile devices
 *
 * Accessibility:
 * - Semantic HTML structure through TitledWidgetWrapper
 * - Expandable descriptions with proper ARIA attributes
 * - Source links open in new tabs for external references
 * - Data attributes for test automation
 *
 * Usage Context:
 * - Display key performance metrics and statistics
 * - Showcase company achievements and milestones
 * - Present data-driven evidence for marketing claims
 * - Integrated in page sections as an informational component
 */

import type { TitledWidget } from '~/types';
import TitledWidgetWrapper from '~/components/ui/TitledWidgetWrapper.astro';
import Expander from '~/components/ui/Expander.astro';
import { Icon } from 'astro-icon/components';
import { getClasses } from '~/utils/theme';

/**
 * Stat interface defining the structure of individual statistical items
 *
 * @property amount - Numerical value or formatted string for the statistic
 * @property title - Short descriptive title for the statistic
 * @property icon - Optional icon identifier for visual representation
 * @property description - Detailed explanation of the statistic (expandable)
 * @property source - URL to the source of the statistical data
 */
export interface Stat {
  amount?: number | string;
  title?: string;
  icon?: string;
  description?: string;
  source?: string;
}

/**
 * Component Props Interface extending TitledWidget
 *
 * @property stats - Array of Stat objects representing statistical items
 * @property sourceLabel - Label text for source links (defaults to '** Source')
 */
export interface Props extends TitledWidget {
  stats?: Array<Stat>;
  sourceLabel?: string;
}

// Destructure props with defaults and slot content rendering
const {
  id,

  // Render slot content for title, subtitle, and tagline if not provided as props
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline = await Astro.slots.render('tagline'),

  // Statistics configuration with defaults
  stats = [],
  sourceLabel = '** Source',

  // Styling and background options with defaults
  classes: rawClasses = {},
  bg = '',
} = Astro.props;

// Retrieve CSS classes for statistics elements from theme configuration
const classes = getClasses('Component+Stats', rawClasses);
---

{
  /*
    TitledWidgetWrapper provides consistent structure for titled components.
    - Renders title, subtitle, and tagline content
    - Applies theme-based styling through classes.wrapper and classes.headline
    - Supports background styling through bg prop
    - Sets type to "stats" for semantic identification
  */
}
<TitledWidgetWrapper type="stats" id={id} classes={classes} bg={bg} title={title} subtitle={subtitle} tagline={tagline}>
  {
    /*
      Main container for statistics widget with theme-based styling.
      - Contains grid layout for statistical items
      - Includes data-name attribute for test automation
    */
  }
  <div class={classes.container} data-name="stats-container">
    {
      /*
        Map through stats array to render individual statistical items.
        - Only renders when stats array has items
        - Each stat is rendered in its own grid item
      */
      stats &&
        stats.map(({ amount, title, icon, description, source }) => (
          /*
            Individual statistical item container with theme-based styling.
            - Contains icon, amount, title/description, and source
            - Includes data-name attribute for test automation
          */
          <div class={classes.stat} data-name="stats-stat">
            {
              /*
                Icon container rendered when icon exists.
                - Provides visual representation for the statistic
                - Includes data-name attribute for test automation
              */
              icon && (
                /*
                  Icon container with theme-based styling.
                  - Wraps Icon component for consistent sizing
                  - Includes data-name attribute for test automation
                */
                <div class={classes.icon_container} data-name="stats-icon-container">
                  {/*
                      Icon component that provides visual context for the statistic.
                      - Uses specified icon identifier
                      - Styled with classes.icon
                    */}
                  <Icon name={icon} class={classes.icon} />
                </div>
              )
            }
            {
              /*
                Amount display rendered when amount exists.
                - Uses set:html to render formatted numerical values
                - Styled with classes.amount
                - Includes data-name attribute for test automation
              */
              amount && <div class={classes.amount} set:html={amount} data-name="stats-amount" />
            }
            {
              /*
                Title/description rendering with conditional logic.
                - Uses Expander component when both title and description exist
                - Renders plain title when only title exists
              */
              title && description ? (
                /*
                  Expander component for detailed descriptions.
                  - Provides expandable/collapsible content
                  - Takes title and description as props
                */
                <Expander title={title} description={description} />
              ) : (
                /*
                  Plain title rendering when no description exists.
                  - Uses set:html for safe HTML content rendering
                */
                <div set:html={title} />
              )
            }
            {
              /*
                Source link container rendered when source exists.
                - Provides credibility for statistical data
                - Includes data-name attribute for test automation
              */
              source && (
                /*
                  Source link container with theme-based styling.
                  - Contains link to statistical source
                  - Includes data-name attribute for test automation
                */
                <div class={classes.source_container} data-name="stats-source-container">
                  {/*
                      Source link that opens in new tab.
                      - Links to the source URL
                      - Uses sourceLabel for display text
                      - Target _blank for external reference
                    */}
                  <a href={source} target="_blank" set:html={sourceLabel} />
                </div>
              )
            }
          </div>
        ))
    }
  </div>
</TitledWidgetWrapper>
