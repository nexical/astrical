---
/**
 * Testimonials.astro
 *
 * This component renders a testimonials widget that displays customer reviews, quotes,
 * or feedback in a grid layout. It's designed to build trust and credibility by showcasing
 * positive experiences from clients or users with optional author information and images.
 *
 * Features:
 * - Titled widget structure with optional title, subtitle, and tagline
 * - Grid layout for multiple testimonial items
 * - Support for testimonial content with author details
 * - Optional author images (avatars or company logos)
 * - Call-to-action button for additional actions
 * - Themeable styling through CSS classes
 * - Accessible structure with proper labeling
 *
 * Props (extends TitledWidget interface):
 * - id (optional): HTML id attribute for the widget container
 * - title (optional): Widget title (can be passed via slot or prop)
 * - subtitle (optional): Widget subtitle (can be passed via slot or prop)
 * - tagline (optional): Widget tagline (can be passed via slot or prop)
 * - testimonials: Array of Testimonial objects representing individual testimonials
 * - callToAction: CallToAction object for additional action button
 * - classes (optional): CSS class configuration object
 * - bg (optional): Background image URL string
 *
 * Testimonial Structure:
 * - title: Testimonial title or category (optional)
 * - testimonial: The actual testimonial quote or review text
 * - name: Author's name
 * - job: Author's job title or company affiliation
 * - image: Either HTML string or ImageMedia object for author image
 *
 * CallToAction Structure:
 * - variant: Button style variant ('primary', 'secondary', 'tertiary', 'link')
 * - text: Button display text
 * - icon: Optional icon identifier
 * - href: URL for link buttons
 * - type: Button type ('button', 'submit', 'reset')
 * - value: Button value attribute
 * - classes: Additional CSS classes for the button
 *
 * ImageMedia Structure:
 * - src: Image source (string path or ImageMetadata object)
 * - alt (optional): Alternative text for the image
 * - href (optional): Link URL for the image
 * - target (optional): Link target attribute (_blank, _self, etc.)
 *
 * Styling Inputs:
 * - getClasses('Component+Testimonials'): Retrieves CSS classes for testimonial elements
 *   from the theme's style configuration:
 *   - wrapper: Classes for the TitledWidgetWrapper container
 *   - headline: Classes for the TitledWidgetWrapper container
 *   - grid: Classes for the testimonials grid layout container
 *   - container: Classes for individual testimonial item containers
 *   - container_inner: Classes for inner testimonial content containers
 *   - title: Classes for testimonial title elements (h2)
 *   - blockquote: Classes for blockquote elements containing testimonials
 *   - testimonial: Classes for testimonial text paragraphs
 *   - divider: Classes for horizontal rule dividers
 *   - footer: Classes for testimonial footer containing author info
 *   - image_container: Classes for author image wrapper containers
 *   - image: Classes for Image components (author avatars)
 *   - author_container: Classes for author information containers
 *   - author_name: Classes for author name text
 *   - author_job: Classes for author job/company text
 *   - action_container: Classes for call-to-action button container
 *
 * Component Integration:
 * - TitledWidgetWrapper: Provides consistent titled widget structure
 * - Button: UI button component for call-to-action
 * - Image: Custom image component for author images
 * - getClasses: Manages theme-based styling
 *
 * Data Flow:
 * 1. Receives testimonials configuration through Astro.props
 * 2. Maps through testimonials array to render individual testimonial items
 * 3. Conditionally renders testimonial content, author info, and images
 * 4. Provides optional call-to-action button below testimonials
 * 5. Wraps content in TitledWidgetWrapper for consistent structure
 * 6. Applies theme-based styling through getClasses utility
 *
 * Layout Structure:
 * - TitledWidgetWrapper provides outer container with title/subtitle/tagline
 * - Grid container holds multiple testimonial items
 * - Each testimonial contains quote, author name, job, and optional image
 * - Call-to-action button positioned below the testimonials grid
 *
 * Responsive Behavior:
 * - Grid layout adapts to screen size with responsive columns
 * - Testimonial items stack vertically on mobile devices
 * - Author images maintain consistent sizing with fixed dimensions
 *
 * Accessibility:
 * - Semantic HTML structure through TitledWidgetWrapper
 * - Proper use of blockquote for testimonial quotes
 * - Data attributes for test automation
 *
 * Usage Context:
 * - Display customer testimonials and reviews
 * - Showcase client feedback and success stories
 * - Build trust through social proof
 * - Integrated in page sections as a credibility-focused component
 */

import type { TitledWidget, CallToAction, ImageMedia } from '~/types';
import TitledWidgetWrapper from '~/components/ui/TitledWidgetWrapper.astro';
import Button from '~/components/ui/Button.astro';
import Image from '~/components/ui/Image.astro';
import { getClasses } from '~/utils/theme';

/**
 * Testimonial interface defining the structure of individual testimonials
 *
 * @property title - Testimonial title or category (optional)
 * @property testimonial - The actual testimonial quote or review text
 * @property name - Author's name
 * @property job - Author's job title or company affiliation
 * @property image - Either HTML string or ImageMedia object for author image
 */
export interface Testimonial {
  title?: string;
  testimonial?: string;
  name?: string;
  job?: string;
  image?: string | ImageMedia;
}

/**
 * Component Props Interface extending TitledWidget
 *
 * @property testimonials - Array of Testimonial objects representing individual testimonials
 * @property callToAction - CallToAction object for additional action button
 */
export interface Props extends TitledWidget {
  testimonials?: Array<Testimonial>;
  callToAction?: CallToAction;
}

// Destructure props with defaults and slot content rendering
const {
  id,

  // Render slot content for title, subtitle, and tagline if not provided as props
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline = await Astro.slots.render('tagline'),

  // Testimonials configuration with defaults
  testimonials = [],
  callToAction,

  // Styling and background options with defaults
  classes: rawClasses = {},
  bg = '',
} = Astro.props;

// Retrieve CSS classes for testimonial elements from theme configuration
const classes = getClasses('Component+Testimonials', rawClasses);
---

{
  /*
    TitledWidgetWrapper provides consistent structure for titled components.
    - Renders title, subtitle, and tagline content
    - Applies theme-based styling through classes.wrapper and classes.headline
    - Supports background styling through bg prop
    - Sets type to "testimonials" for semantic identification
  */
}
<TitledWidgetWrapper
  type="testimonials"
  id={id}
  classes={classes}
  bg={bg}
  title={title}
  subtitle={subtitle}
  tagline={tagline}
>
  {
    /*
      Grid container for testimonials with theme-based styling.
      - Contains multiple testimonial items in a responsive grid
      - Includes data-name attribute for test automation
    */
  }
  <div class={classes.grid} data-name="testimonials-grid">
    {
      /*
        Map through testimonials array to render individual testimonial items.
        - Only renders when testimonials array has items
        - Each testimonial is rendered in its own grid item
      */
      testimonials &&
        testimonials.map(({ title, testimonial, name, job, image }) => (
          /*
            Individual testimonial container with theme-based styling.
            - Contains testimonial content, author info, and image
            - Includes data-name attribute for test automation
          */
          <div class={classes.container} data-name="testimonials-container">
            {/*
                Inner container for testimonial content with theme-based styling.
                - Provides consistent padding and structure
                - Includes data-name attribute for test automation
              */}
            <div class={classes.container_inner} data-name="testimonials-container-inner">
              {
                /*
                  Testimonial title rendered when title exists.
                  - Uses h2 for proper heading hierarchy
                  - Styled with classes.title
                  - Includes data-name attribute for test automation
                */
                title && (
                  <h2 class={classes.title} data-name="testimonials-title">
                    {title}
                  </h2>
                )
              }
              {
                /*
                  Testimonial quote rendered when testimonial exists.
                  - Uses blockquote element for semantic structure
                  - Styled with classes.blockquote
                  - Includes data-name attribute for test automation
                */
                testimonial && (
                  <blockquote class={classes.blockquote} data-name="testimonials-blockquote">
                    {/*
                        Testimonial text paragraph with theme-based styling.
                        - Includes quotation marks around the content
                        - Styled with classes.testimonial
                        - Includes data-name attribute for test automation
                      */}
                    <p class={classes.testimonial} data-name="testimonials-testimonial">
                      " {testimonial} "
                    </p>
                  </blockquote>
                )
              }

              {/*
                  Horizontal rule divider with theme-based styling.
                  - Provides visual separation between quote and author info
                  - Styled with classes.divider
                  - Includes data-name attribute for test automation
                */}
              <hr class={classes.divider} data-name="testimonials-divider" />

              {/*
                  Footer container for author information with theme-based styling.
                  - Contains author image and name/job details
                  - Styled with classes.footer
                  - Includes data-name attribute for test automation
                */}
              <div class={classes.footer} data-name="testimonials-footer">
                {
                  /*
                    Author image container rendered when image exists.
                    - Supports both HTML content and ImageMedia objects
                    - Includes data-name attribute for test automation
                  */
                  image && (
                    /*
                      Author image container with theme-based styling.
                      - Provides consistent sizing and positioning
                      - Includes data-name attribute for test automation
                    */
                    <div class={classes.image_container} data-name="testimonials-image-container">
                      {
                        /*
                          Conditional rendering based on image data type.
                          - String: Render raw HTML content
                          - Object: Render Image component with fixed dimensions
                        */
                        typeof image === 'string' ? (
                          /*
                            Render raw HTML content when image is a string.
                            - Uses Fragment with set:html for safe HTML rendering
                          */
                          <Fragment set:html={image} />
                        ) : (
                          /*
                            Render Image component when image is an ImageMedia object.
                            - Provides fixed-size image optimization
                            - Fixed layout with 40x40 dimensions
                            - Applies theme-based styling through classes.image
                          */
                          <Image
                            class={classes.image}
                            width={40}
                            height={40}
                            widths={[400, 768]}
                            layout="fixed"
                            {...image}
                          />
                        )
                      }
                    </div>
                  )
                }

                {/*
                    Author information container with theme-based styling.
                    - Contains author name and job/company details
                    - Styled with classes.author_container
                    - Includes data-name attribute for test automation
                  */}
                <div class={classes.author_container} data-name="testimonials-author-container">
                  {
                    /*
                      Author name rendered when name exists.
                      - Styled with classes.author_name
                      - Includes data-name attribute for test automation
                    */
                    name && (
                      <p class={classes.author_name} data-name="testimonials-author-name">
                        {name}
                      </p>
                    )
                  }
                  {
                    /*
                      Author job/company rendered when job exists.
                      - Styled with classes.author_job
                      - Includes data-name attribute for test automation
                    */
                    job && (
                      <p class={classes.author_job} data-name="testimonials-author-job">
                        {job}
                      </p>
                    )
                  }
                </div>
              </div>
            </div>
          </div>
        ))
    }
  </div>
  {
    /*
      Call-to-action button container rendered when callToAction exists.
      - Provides additional action below testimonials
      - Styled with classes.action_container
      - Includes data-name attribute for test automation
    */
    callToAction && (
      <div class={classes.action_container} data-name="testimonials-action-container">
        {/*
            Button component configured with call-to-action properties.
            - Uses spread operator to pass all callToAction props
          */}
        <Button {...callToAction} />
      </div>
    )
  }
</TitledWidgetWrapper>
